<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>64Key: Goals of the project</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">64Key
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Packages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Goals of the project </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This project aims to make a device useful to chat and transfer files between computers in a context where there aren't other easy ways to do so. Such a context could be a university lab, since you can't install software on the lab's computer, nor you want to do a login in a website.</p>
<h2>Implementation</h2>
<p>Since we can't install software or drivers on the computer, the device acts as a USB-to-Ethernet adapter and makes a web interface available to the computer. It does also host a WebSocket server to communicate in real-time with the client. Each device can talk with each other through a mesh network.</p>
<h1>Table of Contents</h1>
<ol type="1">
<li><a href="#hardware">Hardware</a></li>
<li><a href="#operating-system">Operating system</a></li>
<li><a href="#gadget-mode-script">Gadget mode script</a></li>
<li><a href="#python-application">Python application</a></li>
</ol>
<h2>Hardware</h2>
<h3>System on a Chip</h3>
<p>There aren't many options to choose from for the hardware, since it must have the following features:</p><ul>
<li>USB peripheral configurable in slave mode</li>
<li>Integrated Wi-Fi to establish a network with other devices</li>
<li>Ethernet and serial ports, just to be able to flash a new firmware during development</li>
<li>All the features above must actually work under Linux</li>
<li>Small form factor</li>
<li>Not too expensive</li>
</ul>
<p>The only platform with all those features is the <a href="https://www.openhacks.com/uploadsproductos/ar9331_datasheet.pdf">AR9331 SoC</a>, and there are some boards on the market based on this chip. They usually ship with 16 MB of <a href="https://www.winbond.com/resource-files/w25q128bv_revh_100313_wo_automotive.pdf">SPI flash memory</a> (the maximum supported) and 64 MB of DDR2 RAM, some of them are:</p><ul>
<li>Carambola2 (<a href="http://www.8devices.com/products/carambola-2">http://www.8devices.com/products/carambola-2</a>)</li>
<li>Arduino Industrial 101 (<a href="http://www.arduino.org/products/boards/arduino-industrial-101">http://www.arduino.org/products/boards/arduino-industrial-101</a>)</li>
</ul>
<p>It must be noted that to be able to configure the USB peripheral in device mode, the pin GPIO13 must be tied low at device boot, but some boards do not make it available in the headers and they need a bit of soldering.</p>
<p>Example: Industrial 101 </p><div class="image">
<img src="../img/board-101-mod.jpg"  alt="Wire soldered from GPIO13 to the nearest ground"/>
</div>
<div class="image">
<img src="../img/board-101-mod-zoom.jpg"  alt="Wire soldered from GPIO13 to the nearest ground"/>
</div>
<h3>Bootloader and flash memory</h3>
<p>The flash memory is divided in 64 KB blocks, for a total of 256 individually addressable blocks. It is accessible at addresses between 0x9f000000 and 0x9fffffff (inclusive), and it's usually divided into partitions as summarized by the following table:</p>
<table class="doxtable">
<tr>
<th>Start address </th><th>Size (hex) </th><th>Blocks </th><th>Description  </th></tr>
<tr>
<td>0x9F000000 </td><td>0x040000 </td><td>4 </td><td>Bootloader (U-Boot) </td></tr>
<tr>
<td>0x9F040000 </td><td>0x010000 </td><td>1 </td><td>Bootloader enviroinment variables </td></tr>
<tr>
<td>0x9F050000 </td><td>0x150000 </td><td>21 </td><td>Linux kernel in uImage format </td></tr>
<tr>
<td>0x9F1A0000 </td><td>0xE50000 </td><td>229 </td><td>Linux root in squashfs format </td></tr>
<tr>
<td>0x9FFF0000 </td><td>0x010000 </td><td>1 </td><td>ART partition </td></tr>
</table>
<p><b>The first two partitions and the ART partition must NEVER be erased / overwritten.</b> The ART partition contains Wi-Fi calibration data specific for the single SoC.</p>
<p>When the board is powered up, the bootloader starts and it's output is available on the serial interface (8N1, 115200 baud). If a specific string is sent over the serial line (usually <code>\n</code>, but <code>lin</code> on this board), you can access the bootloader's shell: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;U-Boot 1.1.5-linino-g2996c856-dirty (Oct  2 2015 - 17:52:14)</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;Linino Board (ar9331) U-boot</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;DRAM:  64 MB</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;Top of RAM usable for U-Boot at: 84000000</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;Reserving 218k for U-Boot at: 83fc8000</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;Reserving 192k for malloc() at: 83f98000</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;Reserving 44 Bytes for Board Info at: 83f97fd4</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;Reserving 36 Bytes for Global Data at: 83f97fb0</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;Reserving 128k for boot params() at: 83f77fb0</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;Stack Pointer at: 83f77f98</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;Now running in RAM - U-Boot at: 83fc8000</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;Flash Manuf Id 0xef, DeviceId0 0x40, DeviceId1 0x18</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;flash size 16777216, sector count = 256</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;Flash: 16 MB</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;In:    serial</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;Out:   serial</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;Err:   serial</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;Net:   eth0: b4:21:8a:00:00:00</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;eth1: b4:21:8a:00:00:01</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;eth0, eth1</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;autoboot in 4 seconds (stop with &#39;lin&#39;)...</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;linino&gt;</div></div><!-- fragment --><p> This shell has to be used to download a new firmware on the board withouth a working OS (through the Ethernet connection). It's also useful to set the memory boot address of the kernel (wich must be the start of the kernel partition).</p>
<ul>
<li>To load a new firmware from a TFTP server at 192.168.1.2: <div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;linino&gt; setenv ipaddr &#39;192.168.1.245&#39;</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;linino&gt; setenv serverip &#39;192.168.1.2&#39;</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;linino&gt; tftp 0x80060000 openwrt-trunk-ar71xx-generic-carambola2-squashfs-sysupgrade.bin;</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;linino&gt; erase 0x9f050000 +0xf90000;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;linino&gt; cp.b $fileaddr 0x9f050000 $filesize;</div></div><!-- fragment --></li>
<li>To set the boot address: <div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;linino&gt; setenv bootcmd &#39;bootm 0x9F050000;&#39;</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;linino&gt; saveenv</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;Saving Environment to Flash...</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;Protect off 9F040000 ... 9F04FFFF</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;Un-Protecting sectors 4..4 in bank 1</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;Un-Protected 1 sectors</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;Erasing Flash...Erase Flash from 0x9f040000 to 0x9f04ffff in Bank # 1</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;First 0x4 last 0x4 sector size 0x10000                                                                                                                                                                            4</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;Erased 1 sectors</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;Writing to Flash... write addr: 9f040000</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;done</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;Protecting sectors 4..4 in bank 1</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;Protected 1 sectors</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;linino&gt;</div></div><!-- fragment --></li>
</ul>
<p>The manual for each shell command is available here: <a href="http://www.denx.de/wiki/view/DULG/Manual">http://www.denx.de/wiki/view/DULG/Manual</a></p>
<p>List of all available commands on the Arduino 101: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;linino&gt; help</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;?       - alias for &#39;help&#39;</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;autoscr - run script from memory</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;base    - print or set address offset</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;bdinfo  - print Board Info structure</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;boot    - boot default, i.e., run &#39;bootcmd&#39;</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;bootd   - boot default, i.e., run &#39;bootcmd&#39;</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;bootelf - Boot from an ELF image in memory</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;bootm   - boot application image from memory</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;bootp   - boot image via network using BootP/TFTP protocol</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;bootvx  - Boot vxWorks from an ELF image</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;cmp     - memory compare</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;coninfo - print console devices and information</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;cp      - memory copy</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;crc32   - checksum calculation</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;dhcp    - invoke DHCP client to obtain IP/boot params</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;echo    - echo args to console</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;erase   - erase FLASH memory</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;ethreg    - S26 PHY Reg rd/wr  utility</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;exit    - exit script</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;flinfo  - print FLASH memory information</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;go      - start application at address &#39;addr&#39;</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;help    - print online help</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;iminfo  - print header information for application image</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;imls    - list all images found in flash</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;itest   - return true/false on integer compare</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;loadb   - load binary file over serial line (kermit mode)</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;loads   - load S-Record file over serial line</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;loady   - load binary file over serial line (ymodem mode)</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;loop    - infinite loop on address range</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;md      - memory display</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;mii     - MII utility commands</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;mm      - memory modify (auto-incrementing)</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;mtest   - simple RAM test</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;mw      - memory write (fill)</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;nfs     - boot image via network using NFS protocol</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;nm      - memory modify (constant address)</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;ping    - send ICMP ECHO_REQUEST to network host</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;printenv- print environment variables</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;progmac - Set ethernet MAC addresses</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;protect - enable or disable FLASH write protection</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;rarpboot- boot image via network using RARP/TFTP protocol</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;reset   - Perform RESET of the CPU</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;run     - run commands in an environment variable</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;saveenv - save environment variables to persistent storage</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;setenv  - set environment variables</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;sleep   - delay execution for some time</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;test    - minimal test like /bin/sh</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;tftpboot- boot image via network using TFTP protocol</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;version - print monitor version</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;linino&gt;</div></div><!-- fragment --><h2>Operating system</h2>
<p>The device runs a patched version of OpenWRT with support for USB gadget mode on the AR9331, wich is available at this repository: <a href="https://github.com/neykov/chipidea-openwrt/tree/chipidea-device">https://github.com/neykov/chipidea-openwrt/tree/chipidea-device</a></p>
<p>To obtain the firmware image, the OS must be compiled from sources. A detailed howto is available at this link: <a href="https://wiki.openwrt.org/doc/howto/build">https://wiki.openwrt.org/doc/howto/build</a></p>
<p>Brief list of steps to build the firmware:</p>
<ul>
<li>Clone the repository and update the list of available packages. All the following steps must be executed while being inside the build root. <div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;git clone https://github.com/neykov/chipidea-openwrt --branch chipidea-device</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;cd chipidea-device</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;./scripts/feeds update -a</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;./scripts/feeds install -a</div></div><!-- fragment --></li>
<li>Write the current timestamp in a version.date file, otherwise <code>make</code> will fail <div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;date +%s &gt; version.date</div></div><!-- fragment --></li>
<li>Move all the files in the <code>openwrt_buildroot</code> directory of this project in the <code>files</code> directory. In this way, those files will be included in the firmware image. <div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;mkdir files</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;cp -r -T /path/to/this/repo/openwrt_buildroot ./files</div></div><!-- fragment --></li>
<li>Copy the build configuration. It can be edited with <code>make menuconfig</code>. <div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;cp /path/to/this/repo/.config ./</div></div><!-- fragment --></li>
<li>Start the compilation with make. It will take many hours. <div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;make</div></div><!-- fragment --></li>
</ul>
<p>Now, you can write the file located at <code>&lt;buildroot dir&gt;/bin/ar71xx/openwrt-ar71xx-generic-carambola2-squashfs-sysupgrade.bin</code> on the memory of the device at the address <code>0x9F050000</code>.</p>
<h2>Gadget mode script</h2>
<p>The USB peripheral of the AR9331 is set as a USB slave by the <code>/etc/init.d/usb_configfs</code> script. It does configure the device as a composite device, that acts at the same time as:</p>
<ul>
<li>RNDIS Ethernet adapter, to create a network connection on Windows devices. Windows just checks the first configuration of the device, so this has to be the first to be set by the script.</li>
<li>CDC Ethernet adapter, same as above but needed on Mac OS hosts.</li>
<li>mass storage device: to make available an HTML redirect page to the user, redirecting him to the web GUI.</li>
</ul>
<p>On Linux computers, both the RNDIS and the CDC driver works.</p>
<h2>Python application</h2>
<p>The Python application running on the device acts as a bridge between the mesh network and the web GUI.</p>
<p>It uses Avahi to discover other devices on the network, and it does open a WebSocket connection with every device found (it doesn't use raw TCP sockets since a WebSocket library has been already included in the project and they provide message delimitation).</p>
<p>Every device has an unique identifier (UID), an username and a list of available services. The main goal of the application is to receive data (JSON objects) from the GUI, check the <code>to</code> field (wich is the UID of the recipient), and forward the object in the <code>data</code> field to the right device. Vice versa, it can also receive data from the other peers, and forward it to the GUI. The application does not change in any way the objects received, so the GUI is free to implement any kind of feature without having to change the Python code. By default, the UID is the IP address of the device. It has to be hardcoded for each device before flashing the firmware by editing the /etc/config/network file.</p>
<h3>Start the application</h3>
<p>Just <code>cd</code> to the folder containing <code>__main__.py</code> and run: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;python3 .</div></div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
